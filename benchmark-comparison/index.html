<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataFusion Bio-Formats Benchmark Comparison</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        select:hover {
            border-color: #4CAF50;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: auto;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .chart {
            margin: 30px 0;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
        }
        .platform-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }
        .platform-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        .platform-tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            font-weight: 600;
        }
        .platform-tab:hover {
            color: #4CAF50;
        }
        #charts {
            min-height: 400px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ DataFusion Bio-Formats Benchmark Comparison</h1>

        <div class="info">
            <strong>Interactive Benchmark Comparison Tool</strong><br>
            Select a baseline version and a target version to compare performance across different platforms and benchmark categories.
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="baseline-select">Baseline Version:</label>
                <select id="baseline-select">
                    <option value="">Select baseline...</option>
                </select>
            </div>

            <div class="control-group">
                <label for="target-select">Target Version:</label>
                <select id="target-select">
                    <option value="">Select target...</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button id="compare-btn" disabled>Generate Comparison</button>
            </div>
        </div>

        <div id="platform-tabs-container" style="display: none;">
            <div class="platform-tabs" id="platform-tabs"></div>
        </div>

        <div id="error-container"></div>
        <div id="charts"></div>

        <hr style="margin: 40px 0;">

        <p style="color: #666; text-align: center;">
            Generated with ‚ù§Ô∏è by DataFusion Bio-Formats Benchmark Framework<br>
            ü§ñ <a href="https://github.com/biodatageeks/datafusion-bio-formats">View on GitHub</a>
        </p>
    </div>

    <script>
        // Embedded data from index.json
        const INDEX = {
  "datasets": [
    {
      "id": "benchmarking@b9d1cffb855377ccab2cfe8d580ebd7215da36dd@linux",
      "label": "benchmarking(b9d1cffb)",
      "ref": "benchmarking",
      "ref_type": "branch",
      "timestamp": "2025-11-10T07:46:01Z",
      "runner": "linux",
      "runner_label": "Linux AMD64",
      "path": "commits/b9d1cffb/linux",
      "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd"
    },
    {
      "id": "benchmarking@b9d1cffb855377ccab2cfe8d580ebd7215da36dd@macos",
      "label": "benchmarking(b9d1cffb)",
      "ref": "benchmarking",
      "ref_type": "branch",
      "timestamp": "2025-11-10T07:46:01Z",
      "runner": "macos",
      "runner_label": "macOS ARM64",
      "path": "commits/b9d1cffb/macos",
      "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd"
    },
    {
      "id": "v0.1.1@b9d1cffb855377ccab2cfe8d580ebd7215da36dd@linux",
      "label": "v0.1.1",
      "ref": "v0.1.1",
      "ref_type": "tag",
      "timestamp": "2025-11-10T07:46:01Z",
      "runner": "linux",
      "runner_label": "Linux AMD64",
      "path": "tags/v0.1.1/linux",
      "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd",
      "is_latest_tag": false
    },
    {
      "id": "v0.1.1@b9d1cffb855377ccab2cfe8d580ebd7215da36dd@macos",
      "label": "v0.1.1",
      "ref": "v0.1.1",
      "ref_type": "tag",
      "timestamp": "2025-11-10T07:46:01Z",
      "runner": "macos",
      "runner_label": "macOS ARM64",
      "path": "tags/v0.1.1/macos",
      "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd",
      "is_latest_tag": false
    }
  ],
  "tags": [
    "v0.1.1"
  ],
  "last_updated": "2025-11-10T07:46:01Z"
};
        const REFS = {
  "benchmarking": {
    "ref": "benchmarking",
    "ref_type": "branch",
    "label": "benchmarking(b9d1cffb)",
    "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd",
    "runners": [
      {
        "runner": "linux",
        "runner_label": "Linux AMD64",
        "path": "commits/b9d1cffb/linux"
      },
      {
        "runner": "macos",
        "runner_label": "macOS ARM64",
        "path": "commits/b9d1cffb/macos"
      }
    ]
  },
  "v0.1.1": {
    "ref": "v0.1.1",
    "ref_type": "tag",
    "label": "v0.1.1",
    "commit_sha": "b9d1cffb855377ccab2cfe8d580ebd7215da36dd",
    "runners": [
      {
        "runner": "linux",
        "runner_label": "Linux AMD64",
        "path": "tags/v0.1.1/linux"
      },
      {
        "runner": "macos",
        "runner_label": "macOS ARM64",
        "path": "tags/v0.1.1/macos"
      }
    ]
  }
};

        // State
        let currentPlatform = null;
        let baselineRef = null;
        let targetRef = null;
        let availablePlatforms = [];

        // Initialize dropdowns with optgroups for tags and commits
        function initializeDropdowns() {
            const baselineSelect = document.getElementById('baseline-select');
            const targetSelect = document.getElementById('target-select');

            // Separate by ref_type
            const tags = [];
            const branches = [];

            Object.entries(REFS).forEach(([ref, data]) => {
                if (data.ref_type === 'tag') {
                    tags.push({ ref, ...data });
                } else {
                    branches.push({ ref, ...data });
                }
            });

            // Sort tags (reverse version order)
            tags.sort((a, b) => b.ref.localeCompare(a.ref));
            // Sort branches by commit timestamp (latest first)
            branches.sort((a, b) => b.commit_sha.localeCompare(a.commit_sha));

            // Add tags optgroup
            if (tags.length > 0) {
                const baselineTagGroup = document.createElement('optgroup');
                baselineTagGroup.label = 'Tags';
                const targetTagGroup = document.createElement('optgroup');
                targetTagGroup.label = 'Tags';

                tags.forEach((item, index) => {
                    const displayLabel = item.ref === INDEX.latest_tag ? `‚≠ê ${item.label}` : item.label;

                    const option1 = document.createElement('option');
                    option1.value = item.ref;
                    option1.textContent = displayLabel;
                    baselineTagGroup.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = item.ref;
                    option2.textContent = displayLabel;
                    targetTagGroup.appendChild(option2);

                    // Set latest tag as default baseline
                    if (item.ref === INDEX.latest_tag) {
                        option1.selected = true;
                    }
                });

                baselineSelect.appendChild(baselineTagGroup);
                targetSelect.appendChild(targetTagGroup);
            }

            // Add branches/commits optgroup
            if (branches.length > 0) {
                const baselineCommitGroup = document.createElement('optgroup');
                baselineCommitGroup.label = 'Commits';
                const targetCommitGroup = document.createElement('optgroup');
                targetCommitGroup.label = 'Commits';

                branches.forEach((item, index) => {
                    const option1 = document.createElement('option');
                    option1.value = item.ref;
                    option1.textContent = item.label;
                    baselineCommitGroup.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = item.ref;
                    option2.textContent = item.label;
                    targetCommitGroup.appendChild(option2);

                    // Set latest commit as default target
                    if (index === 0) {
                        option2.selected = true;
                    }
                });

                baselineSelect.appendChild(baselineCommitGroup);
                targetSelect.appendChild(targetCommitGroup);
            }

            // Enable compare button when both selections are made
            baselineSelect.addEventListener('change', validateSelections);
            targetSelect.addEventListener('change', validateSelections);

            // Initial validation
            validateSelections();
        }

        function validateSelections() {
            const baseline = document.getElementById('baseline-select').value;
            const target = document.getElementById('target-select').value;
            const compareBtn = document.getElementById('compare-btn');

            if (baseline && target && baseline !== target) {
                compareBtn.disabled = false;
            } else {
                compareBtn.disabled = true;
            }
        }

        // Load benchmark data for a ref
        async function loadBenchmarkData(refKey) {
            const refData = REFS[refKey];
            if (!refData) {
                throw new Error(`Reference not found: ${refKey}`);
            }

            const baseUrl = window.location.origin + window.location.pathname.replace('/benchmark-comparison/index.html', '');
            const results = {};

            // Load data for each runner/platform
            for (const runner of refData.runners) {
                const dataUrl = `${baseUrl}/benchmark-data/${runner.path}`;
                try {
                    // Load metadata
                    const metadataResponse = await fetch(`${dataUrl}/../metadata.json`);
                    const metadata = metadataResponse.ok ? await metadataResponse.json() : {};

                    results[runner.runner] = {
                        runner: runner.runner,
                        runner_label: runner.runner_label,
                        metadata: metadata,
                        benchmarks: []
                    };

                    // Try to load benchmark results
                    const resultsUrl = `${dataUrl}/results`;
                    // Note: We'll need a way to list files or have a known structure
                    // For now, we'll try common patterns
                    console.log(`Would load from: ${resultsUrl}`);
                } catch (e) {
                    console.warn(`Could not load data for ${runner.runner}:`, e);
                }
            }

            return {
                ref: refData.ref,
                ref_type: refData.ref_type,
                label: refData.label,
                results: results
            };
        }

        // OLD VERSION - keeping structure for reference
        async function loadBenchmarkDataOld(datasetPath) {
            const baseUrl = window.location.origin + window.location.pathname.replace('/benchmark-comparison/index.html', '');
            const dataUrl = `${baseUrl}/benchmark-data/${datasetPath}`;

            // Load benchmark-info.json
            const infoResponse = await fetch(`${dataUrl}/benchmark-info.json`);
            if (!infoResponse.ok) {
                throw new Error(`Failed to load benchmark info from ${datasetPath}`);
            }
            const info = await infoResponse.json();

            // Discover available platforms
            const platforms = [];
            const results = {};

            // Try to load data from both linux and macos directories
            for (const platform of ['linux', 'macos']) {
                try {
                    const platformUrl = `${dataUrl}/${platform}/${platform}.json`;
                    const platformResponse = await fetch(platformUrl);
                    if (platformResponse.ok) {
                        const platformInfo = await platformResponse.json();
                        platforms.push({
                            name: platform,
                            label: platformInfo.runner || platform,
                            info: platformInfo
                        });

                        // Load all JSON result files from baseline and target
                        const platformResults = [];
                        for (const variant of ['baseline', 'target']) {
                            const variantUrl = `${dataUrl}/${platform}/${variant}/results`;
                            try {
                                // We'll need to discover files - for now, try common patterns
                                // In production, you'd list directory contents or have an index
                                const testResponse = await fetch(`${variantUrl}/gff_parallelism_1threads.json`);
                                if (testResponse.ok) {
                                    const result = await testResponse.json();
                                    result.variant = variant;
                                    platformResults.push(result);
                                }
                            } catch (e) {
                                console.warn(`Could not load ${variant} results for ${platform}`, e);
                            }
                        }
                        results[platform] = platformResults;
                    }
                } catch (e) {
                    console.warn(`Platform ${platform} not available`, e);
                }
            }

            return { platforms, results, info };
        }

        // Generate comparison charts
        async function generateComparison() {
            const baseline = document.getElementById('baseline-select').value;
            const target = document.getElementById('target-select').value;

            if (!baseline || !target || baseline === target) {
                return;
            }

            const chartsDiv = document.getElementById('charts');
            const errorDiv = document.getElementById('error-container');
            errorDiv.innerHTML = '';
            chartsDiv.innerHTML = '<div class="loading">Loading benchmark data...</div>';

            try {
                // Load both baseline and target data
                baselineData = await loadBenchmarkData(baseline);
                targetData = await loadBenchmarkData(target);

                // Find common platforms
                const baselinePlatforms = baselineData.platforms.map(p => p.name);
                const targetPlatforms = targetData.platforms.map(p => p.name);
                availablePlatforms = baselinePlatforms.filter(p => targetPlatforms.includes(p));

                if (availablePlatforms.length === 0) {
                    errorDiv.innerHTML = `
                        <div class="error">
                            <strong>No common platforms found</strong><br>
                            Baseline has: ${baselinePlatforms.join(', ')}<br>
                            Target has: ${targetPlatforms.join(', ')}
                        </div>
                    `;
                    chartsDiv.innerHTML = '';
                    return;
                }

                // Set up platform tabs
                const tabsContainer = document.getElementById('platform-tabs-container');
                const tabsDiv = document.getElementById('platform-tabs');
                tabsDiv.innerHTML = '';

                if (availablePlatforms.length > 1) {
                    tabsContainer.style.display = 'block';
                    availablePlatforms.forEach((platform, index) => {
                        const tab = document.createElement('button');
                        tab.className = 'platform-tab' + (index === 0 ? ' active' : '');
                        const platformInfo = baselineData.platforms.find(p => p.name === platform);
                        tab.textContent = platformInfo ? platformInfo.label : platform;
                        tab.onclick = () => switchPlatform(platform);
                        tabsDiv.appendChild(tab);
                    });
                } else if (availablePlatforms.length === 1) {
                    tabsContainer.style.display = 'block';
                    const platformInfo = baselineData.platforms.find(p => p.name === availablePlatforms[0]);
                    tabsDiv.innerHTML = `<div style="padding: 10px; color: #666;">Platform: ${platformInfo ? platformInfo.label : availablePlatforms[0]}</div>`;
                }

                // Display charts for first available platform
                currentPlatform = availablePlatforms[0];
                displayChartsForPlatform(currentPlatform);

            } catch (error) {
                console.error('Error loading benchmark data:', error);
                errorDiv.innerHTML = `
                    <div class="error">
                        <strong>Error loading benchmark data</strong><br>
                        ${error.message}<br><br>
                        This usually means benchmark data hasn't been generated yet.
                        Run the benchmark workflow from GitHub Actions to generate data.
                    </div>
                `;
                chartsDiv.innerHTML = '';
            }
        }

        // Switch between platforms
        function switchPlatform(platform) {
            currentPlatform = platform;

            // Update tab styling
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.remove('active');
                const platformInfo = baselineData.platforms.find(p => p.name === platform);
                if (tab.textContent === (platformInfo ? platformInfo.label : platform)) {
                    tab.classList.add('active');
                }
            });

            displayChartsForPlatform(platform);
        }

        // Display charts for a specific platform
        function displayChartsForPlatform(platform) {
            const chartsDiv = document.getElementById('charts');

            const baselineResults = baselineData.results[platform] || [];
            const targetResults = targetData.results[platform] || [];

            if (baselineResults.length === 0 && targetResults.length === 0) {
                chartsDiv.innerHTML = `
                    <div class="info">
                        <h3>No benchmark data available for ${platform}</h3>
                        <p>Run benchmarks on this platform to see comparison charts.</p>
                    </div>
                `;
                return;
            }

            // Group results by category
            const categories = new Set();
            [...baselineResults, ...targetResults].forEach(r => {
                if (r.category) categories.add(r.category);
            });

            let html = '<div style="margin: 20px 0;">';
            html += `<h3>Benchmark Comparison</h3>`;
            html += `<p><strong>Baseline:</strong> ${document.getElementById('baseline-select').selectedOptions[0].text}</p>`;
            html += `<p><strong>Target:</strong> ${document.getElementById('target-select').selectedOptions[0].text}</p>`;
            html += '</div>';

            categories.forEach(category => {
                html += `<div id="chart-${category}" class="chart"></div>`;
            });

            chartsDiv.innerHTML = html;

            // Generate Plotly charts for each category
            categories.forEach(category => {
                const baselineCategoryResults = baselineResults.filter(r => r.category === category);
                const targetCategoryResults = targetResults.filter(r => r.category === category);

                createComparisonChart(
                    `chart-${category}`,
                    category,
                    baselineCategoryResults,
                    targetCategoryResults
                );
            });
        }

        // Create a comparison chart using Plotly
        function createComparisonChart(divId, category, baselineResults, targetResults) {
            const benchmarkNames = [...new Set([
                ...baselineResults.map(r => r.benchmark_name),
                ...targetResults.map(r => r.benchmark_name)
            ])];

            const baselineTimes = benchmarkNames.map(name => {
                const result = baselineResults.find(r => r.benchmark_name === name);
                return result ? result.metrics.elapsed_seconds : 0;
            });

            const targetTimes = benchmarkNames.map(name => {
                const result = targetResults.find(r => r.benchmark_name === name);
                return result ? result.metrics.elapsed_seconds : 0;
            });

            const trace1 = {
                x: benchmarkNames,
                y: baselineTimes,
                name: 'Baseline',
                type: 'bar',
                marker: { color: '#636EFA' }
            };

            const trace2 = {
                x: benchmarkNames,
                y: targetTimes,
                name: 'Target',
                type: 'bar',
                marker: { color: '#EF553B' }
            };

            const layout = {
                title: `${category} Benchmarks`,
                xaxis: { title: 'Benchmark' },
                yaxis: { title: 'Time (seconds)' },
                barmode: 'group',
                height: 400
            };

            Plotly.newPlot(divId, [trace1, trace2], layout);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropdowns();

            document.getElementById('compare-btn').addEventListener('click', generateComparison);

            // Show welcome message if no datasets available
            if (datasets.length === 0) {
                document.getElementById('charts').innerHTML = `
                    <div class="info">
                        <h3>No benchmark data available yet</h3>
                        <p>Run the benchmark workflow to generate comparison data.</p>
                        <p><strong>To generate benchmarks:</strong></p>
                        <ol>
                            <li>Go to the GitHub Actions tab</li>
                            <li>Select the "Benchmark" workflow</li>
                            <li>Click "Run workflow"</li>
                            <li>Select your options and run</li>
                        </ol>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
