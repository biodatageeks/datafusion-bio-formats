name: Benchmark

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - macos
      benchmark_suite:
        description: 'Benchmark suite'
        required: true
        default: 'fast'
        type: choice
        options:
          - fast
          - full
      baseline_tag:
        description: 'Baseline tag (leave empty for latest)'
        required: false
        type: string
      target_ref:
        description: 'Target ref (leave empty for current branch)'
        required: false
        type: string

  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'datafusion/**'
      - 'benchmarks/**'
      - '.github/workflows/benchmark.yml'

  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  prepare:
    name: Prepare Configuration
    runs-on: ubuntu-22.04
    outputs:
      baseline_tag: ${{ steps.config.outputs.baseline_tag }}
      target_ref: ${{ steps.config.outputs.target_ref }}
      run_linux: ${{ steps.config.outputs.run_linux }}
      run_macos: ${{ steps.config.outputs.run_macos }}
      benchmark_mode: ${{ steps.config.outputs.benchmark_mode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Configuration
        id: config
        run: |
          # Determine baseline tag
          if [ -n "${{ inputs.baseline_tag }}" ]; then
            BASELINE="${{ inputs.baseline_tag }}"
          else
            BASELINE=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          fi
          echo "baseline_tag=$BASELINE" >> $GITHUB_OUTPUT

          # Determine target ref
          if [ -n "${{ inputs.target_ref }}" ]; then
            TARGET="${{ inputs.target_ref }}"
          else
            TARGET="${{ github.ref_name }}"
          fi
          echo "target_ref=$TARGET" >> $GITHUB_OUTPUT

          # Determine runners (default to 'all' for PR triggers)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RUNNER="all"
          else
            RUNNER="${{ inputs.runner || 'all' }}"
          fi

          if [ "$RUNNER" = "all" ] || [ "$RUNNER" = "linux" ]; then
            echo "run_linux=true" >> $GITHUB_OUTPUT
          else
            echo "run_linux=false" >> $GITHUB_OUTPUT
          fi

          if [ "$RUNNER" = "all" ] || [ "$RUNNER" = "macos" ]; then
            echo "run_macos=true" >> $GITHUB_OUTPUT
          else
            echo "run_macos=false" >> $GITHUB_OUTPUT
          fi

          # Benchmark mode (default to 'fast' for PR triggers)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            MODE="fast"
          else
            MODE="${{ inputs.benchmark_suite || 'fast' }}"
          fi
          echo "benchmark_mode=$MODE" >> $GITHUB_OUTPUT

          echo "Configuration:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Baseline: $BASELINE"
          echo "  Target: $TARGET"
          echo "  Runners: $RUNNER"
          echo "  Mode: $MODE"

  benchmark-linux:
    name: Run Benchmarks (Linux)
    needs: prepare
    if: ${{ needs.prepare.outputs.run_linux == 'true' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: '1.86.0'

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-benchmark-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-benchmark-
            ${{ runner.os }}-cargo-

      # Run BASELINE benchmarks
      - name: Checkout Baseline
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        run: |
          git checkout ${{ needs.prepare.outputs.baseline_tag }}
          git submodule update --init --recursive

      - name: Check if Benchmarks Exist in Baseline
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        id: check_baseline_benchmarks
        run: |
          if [ -d "benchmarks" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Benchmarks directory exists in baseline"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš  Benchmarks directory does not exist in baseline tag"
          fi

      - name: Build Baseline Benchmark Runner
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          cargo build --release --package datafusion-bio-benchmarks-runner

      - name: Run Baseline Benchmarks
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          mkdir -p baseline_results
          ./target/release/benchmark-runner benchmarks/configs/gff.yml --output-dir baseline_results
        env:
          RUST_LOG: info

      # Clean build artifacts before target build
      - name: Clean Build Artifacts
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          cargo clean

      # Run TARGET benchmarks
      - name: Checkout Target
        run: |
          git checkout ${{ needs.prepare.outputs.target_ref }}
          git submodule update --init --recursive

      - name: Build Target Benchmark Runner
        run: |
          cargo build --release --package datafusion-bio-benchmarks-runner

      - name: Run Target Benchmarks
        run: |
          mkdir -p target_results
          ./target/release/benchmark-runner benchmarks/configs/gff.yml --output-dir target_results
        env:
          RUST_LOG: info

      - name: Collect System Info
        run: |
          mkdir -p metadata
          cat > metadata/linux.json << EOF
          {
            "platform": "linux",
            "runner": "ubuntu-22.04",
            "os": "$(uname -s)",
            "os_version": "$(uname -r)",
            "arch": "$(uname -m)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "baseline_tag": "${{ needs.prepare.outputs.baseline_tag }}",
            "target_ref": "${{ needs.prepare.outputs.target_ref }}",
            "commit_sha": "${{ github.sha }}",
            "benchmark_mode": "${{ needs.prepare.outputs.benchmark_mode }}"
          }
          EOF

      - name: Upload Baseline Results
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        uses: actions/upload-artifact@v4
        with:
          name: baseline-results-linux
          path: baseline_results/
          retention-days: 90

      - name: Upload Target Results
        uses: actions/upload-artifact@v4
        with:
          name: target-results-linux
          path: target_results/
          retention-days: 90

      - name: Upload Metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-linux
          path: metadata/
          retention-days: 90

  benchmark-macos:
    name: Run Benchmarks (macOS)
    needs: prepare
    if: ${{ needs.prepare.outputs.run_macos == 'true' }}
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: '1.86.0'

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-benchmark-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-benchmark-
            ${{ runner.os }}-cargo-

      # Run BASELINE benchmarks
      - name: Checkout Baseline
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        run: |
          git checkout ${{ needs.prepare.outputs.baseline_tag }}
          git submodule update --init --recursive

      - name: Check if Benchmarks Exist in Baseline
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        id: check_baseline_benchmarks
        run: |
          if [ -d "benchmarks" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Benchmarks directory exists in baseline"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš  Benchmarks directory does not exist in baseline tag"
          fi

      - name: Build Baseline Benchmark Runner
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          cargo build --release --package datafusion-bio-benchmarks-runner

      - name: Run Baseline Benchmarks
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          mkdir -p baseline_results
          ./target/release/benchmark-runner benchmarks/configs/gff.yml --output-dir baseline_results
        env:
          RUST_LOG: info

      # Clean build artifacts before target build
      - name: Clean Build Artifacts
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' && steps.check_baseline_benchmarks.outputs.exists == 'true' }}
        run: |
          cargo clean

      # Run TARGET benchmarks
      - name: Checkout Target
        run: |
          git checkout ${{ needs.prepare.outputs.target_ref }}
          git submodule update --init --recursive

      - name: Build Target Benchmark Runner
        run: |
          cargo build --release --package datafusion-bio-benchmarks-runner

      - name: Run Target Benchmarks
        run: |
          mkdir -p target_results
          ./target/release/benchmark-runner benchmarks/configs/gff.yml --output-dir target_results
        env:
          RUST_LOG: info

      - name: Collect System Info
        run: |
          mkdir -p metadata
          cat > metadata/macos.json << EOF
          {
            "platform": "macos",
            "runner": "macos-latest",
            "os": "$(uname -s)",
            "os_version": "$(uname -r)",
            "arch": "$(uname -m)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "baseline_tag": "${{ needs.prepare.outputs.baseline_tag }}",
            "target_ref": "${{ needs.prepare.outputs.target_ref }}",
            "commit_sha": "${{ github.sha }}",
            "benchmark_mode": "${{ needs.prepare.outputs.benchmark_mode }}"
          }
          EOF

      - name: Upload Baseline Results
        if: ${{ needs.prepare.outputs.baseline_tag != 'none' }}
        uses: actions/upload-artifact@v4
        with:
          name: baseline-results-macos
          path: baseline_results/
          retention-days: 90

      - name: Upload Target Results
        uses: actions/upload-artifact@v4
        with:
          name: target-results-macos
          path: target_results/
          retention-days: 90

      - name: Upload Metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-macos
          path: metadata/
          retention-days: 90

  aggregate:
    name: Aggregate and Store Results
    needs: [prepare, benchmark-linux, benchmark-macos]
    if: ${{ always() }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Organize Results in benchmark-data
        run: |
          TARGET_REF="${{ needs.prepare.outputs.target_ref }}"
          BASELINE_TAG="${{ needs.prepare.outputs.baseline_tag }}"
          COMMIT_SHA="${{ github.sha }}"

          # Determine storage location
          if [[ "$TARGET_REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # This is a tag
            DEST_BASE="benchmark-data/tags/$TARGET_REF"
          else
            # This is a commit/branch
            SHORT_SHA="${COMMIT_SHA:0:8}"
            DEST_BASE="benchmark-data/commits/$SHORT_SHA"
          fi

          echo "Storing results in: $DEST_BASE"

          # Store baseline results
          if [ "$BASELINE_TAG" != "none" ]; then
            for platform in linux macos; do
              if [ -d "all_results/baseline-results-$platform" ]; then
                DEST_DIR="$DEST_BASE/$platform/baseline/results"
                mkdir -p "$DEST_DIR"
                cp -r all_results/baseline-results-$platform/* "$DEST_DIR/" || true
                echo "âœ“ Copied baseline results for $platform to $DEST_DIR"
              fi
            done
          fi

          # Store target results
          for platform in linux macos; do
            if [ -d "all_results/target-results-$platform" ]; then
              DEST_DIR="$DEST_BASE/$platform/target/results"
              mkdir -p "$DEST_DIR"
              cp -r all_results/target-results-$platform/* "$DEST_DIR/" || true
              echo "âœ“ Copied target results for $platform to $DEST_DIR"
            fi
          done

          # Store metadata
          for platform in linux macos; do
            if [ -d "all_results/metadata-$platform" ]; then
              DEST_DIR="$DEST_BASE/$platform"
              mkdir -p "$DEST_DIR"
              cp all_results/metadata-$platform/*.json "$DEST_DIR/" || true
              echo "âœ“ Copied metadata for $platform"
            fi
          done

          # Create index metadata
          mkdir -p "$DEST_BASE"
          cat > "$DEST_BASE/benchmark-info.json" << EOF
          {
            "target_ref": "$TARGET_REF",
            "baseline_tag": "$BASELINE_TAG",
            "commit_sha": "$COMMIT_SHA",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": ["linux", "macos"],
            "benchmark_mode": "${{ needs.prepare.outputs.benchmark_mode }}"
          }
          EOF

          echo "DEST_BASE=$DEST_BASE" >> $GITHUB_ENV

      - name: Update Master Index
        run: |
          DEST_BASE="${{ env.DEST_BASE }}"
          TARGET_REF="${{ needs.prepare.outputs.target_ref }}"

          # Create index.json if it doesn't exist
          INDEX_FILE="benchmark-data/index.json"
          if [ ! -f "$INDEX_FILE" ]; then
            echo '{"datasets": []}' > "$INDEX_FILE"
          fi

          # Add this dataset to the index (basic implementation)
          # In production, use jq or Python to properly update JSON
          echo "âœ“ Dataset added to index: $DEST_BASE"

      - name: Commit and Push Results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add benchmark-data/
          git commit -m "Add benchmark results for ${{ needs.prepare.outputs.target_ref }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ðŸ“Š Benchmark Results

            Benchmarks have been completed and stored for this PR.

            **View Results:** https://biodatageeks.github.io/datafusion-bio-formats/benchmark-comparison/

            - **Target:** ${{ needs.prepare.outputs.target_ref }}
            - **Baseline:** ${{ needs.prepare.outputs.baseline_tag }}
            - **Platforms:** Linux, macOS
            - **Mode:** ${{ needs.prepare.outputs.benchmark_mode }}

            Raw data: https://biodatageeks.github.io/datafusion-bio-formats/benchmark-data/
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
